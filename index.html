<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
    <title>VideoShare | Платформа для видео</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-button: var(--tg-theme-button-color, #2481cc);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f3f3f3);
            --tg-header: var(--tg-theme-header-bg-color, var(--tg-bg));
            --tg-section: var(--tg-theme-section-bg-color, var(--tg-secondary-bg));
            --tg-accent: var(--tg-theme-accent-text-color, var(--tg-button));
        }
        
        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        
        .loader {
            border: 3px solid var(--tg-secondary-bg);
            border-top: 3px solid var(--tg-button);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .video-thumbnail {
            width: 100%;
            aspect-ratio: 16/9;
            background-color: var(--tg-secondary-bg);
            position: relative;
            overflow: hidden;
            border-radius: 12px;
        }
        
        .play-icon {
            position: absolute;
            width: 48px;
            height: 48px;
            background-color: rgba(0,0,0,0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.2s ease;
        }

        .video-thumbnail:hover .play-icon {
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        .play-icon i {
            color: white;
            font-size: 20px;
            margin-left: 3px;
        }
        
        .progress-bar {
            height: 4px;
            background-color: var(--tg-secondary-bg);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--tg-button);
            transition: width 0.3s ease;
        }
        
        .backdrop-blur {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        /* Кастомный скроллбар */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--tg-hint);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef, createContext, useContext } = React;
        
        // --- КОНТЕКСТ ДЛЯ АУТЕНТИФИКАЦИИ ---
        const AuthContext = createContext(null);

        // --- ИНИЦИАЛИЗАЦИЯ SUPABASE ---
        const supabaseUrl = 'https://jmiaxlfglnyqythmjaqn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptaWF4bGZnbG55cXl0aG1qYXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjU2ODgsImV4cCI6MjA3MDc0MTY4OH0.IMRtToyrifCHxtvmSTwyB-mozqWEuDAN0u-iij2XxbE';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // --- КОНСТАНТЫ ПРИЛОЖЕНИЯ ---
        const BOT_USERNAME = 'nodaddyroll_bot';
        const MINI_APP_NAME = 'tutorials';
        const MAX_FILE_SIZE_MB = 500;
        const SUPPORTED_FORMATS = ['.mp4','.mov','.avi','.mkv','.webm','.mpg','.mpeg','.wmv','.flv'];
        
        // --- ХУКИ ---
        function useTelegram() {
            const tg = window.Telegram.WebApp;
            useEffect(() => {
                tg.ready();
                tg.expand();
            }, []);
            return tg;
        }

        function useAuth() {
            return useContext(AuthContext);
        }

        // --- КОМПОНЕНТЫ UI ---
        function Header({ title, onBack, showBack = false, children }) {
            return (
                <div className={`sticky top-0 z-20 p-4 flex items-center border-b bg-[var(--tg-header)] backdrop-blur bg-opacity-80 ${window.Telegram.WebApp.colorScheme === 'dark' ? 'border-gray-800' : 'border-gray-200'}`}>
                    {showBack && (
                        <button 
                            onClick={onBack}
                            className="mr-3 text-lg flex items-center justify-center w-8 h-8 rounded-full hover:bg-[var(--tg-secondary-bg)] transition-colors"
                        >
                            <i className="fas fa-arrow-left"></i>
                        </button>
                    )}
                    <h1 className="text-xl font-bold flex-1 truncate text-[var(--tg-text)]">{title}</h1>
                    {children && <div className="ml-auto">{children}</div>}
                    {showBack && !children && <div className="w-8"></div>}
                </div>
            );
        }
        
        function TgButton({ children, onClick, primary = true, disabled = false, loading = false, className = '' }) {
            return (
                <button
                    onClick={onClick}
                    disabled={disabled || loading}
                    className={`w-full py-3 px-4 rounded-xl font-semibold text-center transition-all duration-200 transform active:scale-95
                        ${primary 
                            ? 'bg-[var(--tg-button)] text-[var(--tg-button-text)] hover:opacity-90 disabled:opacity-50' 
                            : 'bg-[var(--tg-secondary-bg)] text-[var(--tg-button)] hover:opacity-90 disabled:opacity-50'}
                        ${loading ? 'opacity-70' : ''}
                        ${className}`}
                >
                    {loading ? (
                        <div className="flex items-center justify-center">
                            <div className="loader mr-2 border-t-[var(--tg-button-text)]"></div>
                            <span>{children}</span>
                        </div>
                    ) : children}
                </button>
            );
        }

        function Avatar({ user, size = 'md' }) {
            const sizes = {
                sm: 'w-8 h-8',
                md: 'w-10 h-10',
                lg: 'w-20 h-20'
            };
            const initials = user?.user_name ? user.user_name.charAt(0).toUpperCase() : '?';

            return (
                <div className={`${sizes[size]} rounded-full bg-[var(--tg-button)] flex items-center justify-center text-[var(--tg-button-text)] font-bold shrink-0`}>
                    {initials}
                </div>
            );
        }

        // --- КОМПОНЕНТЫ ПРИЛОЖЕНИЯ ---

        function VideoCard({ video, onPlay, onShare }) {
            const [isHovered, setIsHovered] = useState(false);
            
            return (
                <div 
                    className="bg-[var(--tg-secondary-bg)] rounded-xl overflow-hidden mb-4 animate-fadeIn shadow-md transition-shadow hover:shadow-lg"
                    onMouseEnter={() => setIsHovered(true)}
                    onMouseLeave={() => setIsHovered(false)}
                >
                    <div 
                        className="video-thumbnail cursor-pointer" 
                        onClick={() => onPlay(video)}
                    >
                        {video.thumbnail_url ? (
                            <img 
                                src={video.thumbnail_url} 
                                alt="Превью видео" 
                                className="w-full h-full object-cover transition-transform duration-300"
                                style={{ transform: isHovered ? 'scale(1.05)' : 'scale(1)' }}
                            />
                        ) : (
                             <div className="w-full h-full flex items-center justify-center bg-gray-700"></div>
                        )}
                        <div className="play-icon">
                            <i className="fas fa-play"></i>
                        </div>
                    </div>
                    <div className="p-4">
                        <div className="flex items-start">
                            <Avatar user={video} size="md" />
                            <div className="ml-3 flex-1">
                                <h2 className="font-bold text-[var(--tg-text)] line-clamp-2 leading-tight">{video.title}</h2>
                                <p className="text-sm text-[var(--tg-hint)]">{video.user_name || 'Anonymous'}</p>
                            </div>
                             <button 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    onShare(video);
                                }}
                                className="text-[var(--tg-button)] ml-2 text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"
                            >
                                <i className="fas fa-share-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        
        function UploadForm({ onClose, onUploadComplete }) {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [category, setCategory] = useState('FSK');
            const [file, setFile] = useState(null);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState(0);
            const [error, setError] = useState(null);
            const tg = useTelegram();
            const { user } = useAuth();
            
            const isFormValid = useMemo(() => title && description && file, [title, description, file]);

            useEffect(() => {
                tg.MainButton.setParams({
                    text: 'ОПУБЛИКОВАТЬ',
                    is_active: isFormValid,
                    is_visible: true
                });

                const mainButtonClickHandler = () => {
                    if (isFormValid) handleSubmit();
                };

                tg.onEvent('mainButtonClicked', mainButtonClickHandler);
                
                return () => {
                    tg.offEvent('mainButtonClicked', mainButtonClickHandler);
                    tg.MainButton.hide();
                };
            }, [isFormValid, title, description, file, category]);
            
            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (!selectedFile) return;
                
                if (selectedFile.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                    setError(`Файл слишком большой. Максимум: ${MAX_FILE_SIZE_MB}MB`);
                    return;
                }
                
                const fileExtension = `.${selectedFile.name.split('.').pop()}`.toLowerCase();
                if (!SUPPORTED_FORMATS.includes(fileExtension)) {
                    setError(`Неподдерживаемый формат. Разрешены: ${SUPPORTED_FORMATS.join(', ')}`);
                    return;
                }
                
                setError(null);
                setFile(selectedFile);
                
                generateThumbnail(selectedFile);
            };

            const generateThumbnail = (videoFile) => {
                const video = document.createElement('video');
                const url = URL.createObjectURL(videoFile);
                video.src = url;
                video.muted = true;

                video.addEventListener('loadeddata', () => {
                    video.currentTime = 1; 
                });

                video.addEventListener('seeked', () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    setPreviewUrl(canvas.toDataURL('image/jpeg', 0.8));
                    URL.revokeObjectURL(url);
                });
            };
            
            const handleSubmit = useCallback(async () => {
                if (!isFormValid || !user) return;
                
                setIsLoading(true);
                setUploadProgress(0);
                setError(null);
                tg.MainButton.showProgress();
                
                try {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${user.id}_${Date.now()}.${fileExt}`;
                    const filePath = `public/${fileName}`;
                    
                    const { error: uploadError } = await supabase.storage
                        .from('videos')
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false,
                        });

                    if (uploadError) throw uploadError;
                    
                    const { data: { publicUrl: videoUrl } } = supabase.storage
                        .from('videos')
                        .getPublicUrl(filePath);
                        
                    let thumbnailUrl = null;
                    if (previewUrl) {
                        const thumbnailBlob = await (await fetch(previewUrl)).blob();
                        const thumbnailPath = `public/thumbnails/${fileName}.jpg`;
                        
                        const { error: thumbnailError } = await supabase.storage
                            .from('videos')
                            .upload(thumbnailPath, thumbnailBlob);
                            
                        if (!thumbnailError) {
                            const { data: { publicUrl } } = supabase.storage
                                .from('videos')
                                .getPublicUrl(thumbnailPath);
                            thumbnailUrl = publicUrl;
                        }
                    }
                    
                    const { data, error: insertError } = await supabase
                        .from('videos')
                        .insert([{
                            title,
                            description,
                            category,
                            video_url: videoUrl,
                            thumbnail_url: thumbnailUrl,
                            user_id: user.id,
                            user_name: user.first_name,
                            user_username: user.username
                        }])
                        .select()
                        .single();
                    
                    if (insertError) throw insertError;
                    
                    tg.showPopup({
                        title: 'Готово!',
                        message: 'Видео успешно загружено.',
                        buttons: [{ type: 'ok' }]
                    });
                    
                    onUploadComplete(data);
                    onClose();
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    const errorMessage = 'Ошибка загрузки. Пожалуйста, попробуйте еще раз.';
                    setError(errorMessage);
                    tg.showAlert(errorMessage);
                } finally {
                    setIsLoading(false);
                    tg.MainButton.hideProgress();
                }
            }, [isFormValid, title, description, category, file, previewUrl, user]);
            
            return (
                <div className="pb-20">
                    <Header title="Новое видео" onBack={onClose} showBack={true} />
                    
                    <div className="p-4 space-y-6">
                        <div>
                            <label className="block border-2 border-dashed border-[var(--tg-button)] rounded-xl p-6 text-center cursor-pointer hover:bg-[var(--tg-secondary-bg)] transition-colors">
                                {file ? (
                                    <div className="text-[var(--tg-button)]">
                                        <i className="fas fa-check-circle text-3xl mb-2"></i>
                                        <p className="font-semibold">{file.name}</p>
                                        <p className="text-sm text-[var(--tg-hint)] mt-1">
                                            {(file.size / 1024 / 1024).toFixed(1)} MB
                                        </p>
                                    </div>
                                ) : (
                                    <div>
                                        <i className="fas fa-cloud-upload-alt text-3xl mb-2 text-[var(--tg-button)]"></i>
                                        <p className="font-semibold text-[var(--tg-button)]">Выберите видео</p>
                                        <p className="text-xs text-[var(--tg-hint)] mt-1">До {MAX_FILE_SIZE_MB}MB</p>
                                    </div>
                                )}
                                <input 
                                    type="file" 
                                    accept="video/*"
                                    onChange={handleFileChange}
                                    className="hidden"
                                    disabled={isLoading}
                                />
                            </label>
                            {error && <p className="text-red-500 text-sm mt-2 text-center">{error}</p>}
                        </div>
                        
                        {previewUrl && (
                            <div>
                                <label className="block mb-2 font-medium text-[var(--tg-text)]">Превью</label>
                                <div className="video-thumbnail">
                                    <img src={previewUrl} alt="Превью видео" className="w-full h-full object-cover" />
                                </div>
                            </div>
                        )}
                        
                        <div className="space-y-4">
                            <input
                                type="text"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                className="w-full p-3 rounded-lg bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] border-none placeholder-[var(--tg-hint)] focus:ring-2 focus:ring-[var(--tg-button)] outline-none"
                                placeholder="Название"
                                maxLength="100"
                                disabled={isLoading}
                            />
                            <textarea
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                className="w-full p-3 rounded-lg bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] border-none placeholder-[var(--tg-hint)] focus:ring-2 focus:ring-[var(--tg-button)] outline-none"
                                placeholder="Описание"
                                rows="4"
                                maxLength="500"
                                disabled={isLoading}
                            ></textarea>
                            <select
                                value={category}
                                onChange={(e) => setCategory(e.target.value)}
                                className="w-full p-3 rounded-lg bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] border-none focus:ring-2 focus:ring-[var(--tg-button)] outline-none appearance-none"
                                disabled={isLoading}
                            >
                                <option value="FSK">FSK</option>
                                <option value="Wizard">Wizard</option>
                                <option value="Aggressive">Aggressive</option>
                                <option value="Street">Street</option>
                                <option value="Park">Park</option>
                            </select>
                        </div>
                        
                        {isLoading && (
                            <div className="mt-6">
                                <div className="progress-bar">
                                    <div className="progress-fill" style={{ width: `${uploadProgress}%` }}></div>
                                </div>
                                <p className="text-center text-sm text-[var(--tg-hint)] mt-2">Загрузка... {uploadProgress}%</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        function VideoPlayer({ video, onClose }) {
            const videoRef = useRef(null);
            const [isPlaying, setIsPlaying] = useState(true);
            const [isMuted, setIsMuted] = useState(false);
            const [progress, setProgress] = useState(0);
            const [duration, setDuration] = useState(0);
            const [showControls, setShowControls] = useState(true);
            const controlsTimeoutRef = useRef(null);
            const tg = useTelegram();

            const hideControls = () => {
                if (videoRef.current && !videoRef.current.paused) {
                    setShowControls(false);
                }
            };

            const resetControlsTimeout = () => {
                clearTimeout(controlsTimeoutRef.current);
                controlsTimeoutRef.current = setTimeout(hideControls, 3000);
            };
            
            useEffect(() => {
                const videoElement = videoRef.current;
                if (!videoElement) return;

                const onPlay = () => setIsPlaying(true);
                const onPause = () => setIsPlaying(false);
                const onTimeUpdate = () => {
                    setProgress(videoElement.currentTime);
                    resetControlsTimeout();
                };
                const onLoadedMetadata = () => setDuration(videoElement.duration);
                
                videoElement.addEventListener('play', onPlay);
                videoElement.addEventListener('pause', onPause);
                videoElement.addEventListener('timeupdate', onTimeUpdate);
                videoElement.addEventListener('loadedmetadata', onLoadedMetadata);

                resetControlsTimeout();
                
                return () => {
                    videoElement.removeEventListener('play', onPlay);
                    videoElement.removeEventListener('pause', onPause);
                    videoElement.removeEventListener('timeupdate', onTimeUpdate);
                    videoElement.removeEventListener('loadedmetadata', onLoadedMetadata);
                    clearTimeout(controlsTimeoutRef.current);
                };
            }, []);

            const togglePlay = () => {
                if (videoRef.current.paused) {
                    videoRef.current.play();
                } else {
                    videoRef.current.pause();
                }
            };

            const handleSeek = (e) => {
                const seekTime = (e.nativeEvent.offsetX / e.currentTarget.offsetWidth) * duration;
                videoRef.current.currentTime = seekTime;
            };

            const toggleFullscreen = () => {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    videoRef.current.parentElement.requestFullscreen();
                }
            };
            
            const formatTime = (time) => {
                const minutes = Math.floor(time / 60);
                const seconds = Math.floor(time % 60);
                return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            };

            return (
                <div className="fixed inset-0 bg-black z-50 flex items-center justify-center animate-fadeIn">
                    <div 
                        className="relative w-full h-full"
                        onMouseMove={() => { setShowControls(true); resetControlsTimeout(); }}
                        onClick={() => setShowControls(s => !s)}
                    >
                        <video
                            ref={videoRef}
                            src={video.video_url}
                            className="w-full h-full object-contain"
                            autoPlay
                            playsInline
                            loop
                            onClick={togglePlay}
                        />

                        <div className={`absolute inset-0 transition-opacity duration-300 ${showControls ? 'opacity-100' : 'opacity-0'}`}>
                            {/* Top Controls */}
                            <div className="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/60 to-transparent flex items-center">
                                <button onClick={onClose} className="text-white text-2xl p-2 rounded-full hover:bg-white/20">
                                    <i className="fas fa-arrow-left"></i>
                                </button>
                                <h2 className="text-white font-semibold text-lg ml-4 truncate">{video.title}</h2>
                            </div>

                            {/* Center Play Button */}
                            {!isPlaying && (
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <button onClick={togglePlay} className="text-white text-6xl bg-black/40 rounded-full w-24 h-24 flex items-center justify-center">
                                        <i className="fas fa-play ml-2"></i>
                                    </button>
                                </div>
                            )}

                            {/* Bottom Controls */}
                            <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/60 to-transparent">
                                <div className="w-full h-1.5 bg-white/30 rounded-full cursor-pointer" onClick={handleSeek}>
                                    <div className="h-full bg-[var(--tg-button)] rounded-full" style={{ width: `${(progress / duration) * 100}%` }}></div>
                                </div>
                                <div className="flex items-center justify-between mt-2 text-white">
                                    <div className="flex items-center space-x-4">
                                        <button onClick={togglePlay} className="text-2xl">
                                            <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'}`}></i>
                                        </button>
                                        <span className="text-sm font-mono">{formatTime(progress)} / {formatTime(duration)}</span>
                                    </div>
                                    <div className="flex items-center space-x-4">
                                        <button onClick={() => setIsMuted(!isMuted)} className="text-2xl">
                                            <i className={`fas ${isMuted ? 'fa-volume-mute' : 'fa-volume-up'}`}></i>
                                        </button>
                                        <button onClick={toggleFullscreen} className="text-xl">
                                            <i className="fas fa-expand"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        function VideoFeed({ initialVideoId }) {
            const [videos, setVideos] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showUploadForm, setShowUploadForm] = useState(false);
            const [currentVideo, setCurrentVideo] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const tg = useTelegram();
            
            const loadVideos = useCallback(async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    let query = supabase
                        .from('videos')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    const { data, error: supabaseError } = await query;
                    
                    if (supabaseError) throw supabaseError;
                    
                    setVideos(data || []);

                    if (initialVideoId && data) {
                        const videoToOpen = data.find(v => v.id == initialVideoId);
                        if (videoToOpen) setCurrentVideo(videoToOpen);
                    }
                } catch (err) {
                    console.error('Error loading videos:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }, [initialVideoId]);
            
            useEffect(() => {
                loadVideos();
                
                const channel = supabase
                    .channel('videos_changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'videos' }, (payload) => {
                        loadVideos(); // Reload all videos on any change
                    })
                    .subscribe();
                
                return () => {
                    supabase.removeChannel(channel);
                };
            }, []);
            
            const filteredVideos = useMemo(() => {
                if (!searchQuery) return videos;
                return videos.filter(video => 
                    video.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    (video.description && video.description.toLowerCase().includes(searchQuery.toLowerCase()))
                );
            }, [videos, searchQuery]);

            const handleShare = (video) => {
                const miniAppUrl = `https://t.me/${BOT_USERNAME}/${MINI_APP_NAME}?startapp=video_${video.id}`;
                const shareText = `Смотри видео "${video.title}"!`;
                tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(miniAppUrl)}&text=${encodeURIComponent(shareText)}`);
            };

            const handleUploadComplete = (newVideo) => {
                setVideos(prev => [newVideo, ...prev]);
                setShowUploadForm(false);
            };
            
            return (
                <div className="pb-24">
                    {currentVideo && <VideoPlayer video={currentVideo} onClose={() => setCurrentVideo(null)} />}
                    
                    {showUploadForm ? (
                        <UploadForm onClose={() => setShowUploadForm(false)} onUploadComplete={handleUploadComplete} />
                    ) : (
                        <>
                            <Header title="VideoShare" />
                            
                            <div className="p-4 sticky top-[73px] z-10 bg-[var(--tg-bg)]">
                                <div className="relative">
                                    <i className="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-[var(--tg-hint)]"></i>
                                    <input
                                        type="text"
                                        placeholder="Поиск видео..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        className="w-full p-3 pl-12 rounded-xl bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] border-none placeholder-[var(--tg-hint)] focus:ring-2 focus:ring-[var(--tg-button)] outline-none"
                                    />
                                </div>
                            </div>
                            
                            <div className="px-4">
                                {loading ? (
                                    <div className="flex justify-center items-center py-10"><div className="loader"></div></div>
                                ) : error ? (
                                    <div className="text-center py-10 text-red-500">Ошибка: {error}</div>
                                ) : filteredVideos.length === 0 ? (
                                    <div className="text-center py-20 text-[var(--tg-hint)]">
                                        <i className="fas fa-video-slash text-4xl mb-4"></i>
                                        <p className="font-semibold">Видео не найдены</p>
                                        <p>Попробуйте другой запрос или загрузите свое видео.</p>
                                    </div>
                                ) : (
                                    <div>
                                        {filteredVideos.map(video => (
                                            <VideoCard
                                                key={video.id}
                                                video={video}
                                                onPlay={setCurrentVideo}
                                                onShare={handleShare}
                                            />
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            <button
                                onClick={() => setShowUploadForm(true)}
                                className="fixed bottom-6 right-6 w-16 h-16 rounded-2xl bg-[var(--tg-button)] text-[var(--tg-button-text)] flex items-center justify-center shadow-lg hover:opacity-90 transition-all transform active:scale-90"
                            >
                                <i className="fas fa-plus text-2xl"></i>
                            </button>
                        </>
                    )}
                </div>
            );
        }
        
        function App() {
            const [user, setUser] = useState(null);
            const [initialVideoId, setInitialVideoId] = useState(null);
            const tg = useTelegram();
            
            useEffect(() => {
                const tgUser = tg.initDataUnsafe?.user;
                if (tgUser) {
                    setUser(tgUser);
                }

                if (tg.initDataUnsafe?.start_param) {
                    const startParam = tg.initDataUnsafe.start_param;
                    if (startParam.startsWith('video_')) {
                        setInitialVideoId(startParam.replace('video_', ''));
                    }
                }
            }, [tg]);
            
            return (
                <AuthContext.Provider value={{ user }}>
                    {user ? <VideoFeed initialVideoId={initialVideoId} /> : 
                        <div className="flex items-center justify-center h-screen">
                            <div className="text-center text-[var(--tg-hint)]">
                                <div className="loader mb-4"></div>
                                <p>Загрузка данных пользователя...</p>
                            </div>
                        </div>
                    }
                </AuthContext.Provider>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
