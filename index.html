<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Tutorials</title>
    <!-- Tailwind CSS –¥–ª—è —Å—Ç–∏–ª–µ–π -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel –¥–ª—è JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        window.initializeApp = initializeApp;
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.onSnapshot = onSnapshot;
        window.doc = doc;
        window.getDoc = getDoc;
        window.query = query;
        window.orderBy = orderBy;
    </script>

    <style>
        body {
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--tg-theme-button-color, #3498db);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // ----------------------------------------------------

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = window.initializeApp(firebaseConfig);
        const db = window.getFirestore(app);
        const videosCollection = window.collection(db, "videos");

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–∏–¥–µ–æ
        function VideoCard({ video }) {
            return (
                <div className="bg-[var(--tg-theme-secondary-bg-color)] rounded-xl shadow-md overflow-hidden m-2">
                    <div className="p-4">
                        <div className="uppercase tracking-wide text-sm text-[var(--tg-theme-button-color)] font-bold">{video.category}</div>
                        <h2 className="block mt-1 text-lg leading-tight font-medium text-[var(--tg-theme-text-color)]">{video.title}</h2>
                        <p className="mt-2 text-[var(--tg-theme-hint-color)]">{video.description}</p>
                        <p className="mt-2 text-xs text-[var(--tg-theme-hint-color)]">–ó–∞–≥—Ä—É–∑–∏–ª: {video.uploaderName}</p>
                    </div>
                </div>
            );
        }
        
        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Ñ–æ—Ä–º—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–∏–¥–µ–æ
        function AddMetadataForm({ fileId, uploaderInfo }) {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [category, setCategory] = useState('FSK');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const tg = window.Telegram.WebApp;

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!title || !description) {
                    setError('–ù–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.');
                    return;
                }
                setIsLoading(true);
                setError('');

                try {
                    await window.addDoc(videosCollection, {
                        title,
                        description,
                        category,
                        fileId,
                        uploaderId: uploaderInfo.id,
                        uploaderName: uploaderInfo.firstName,
                        uniqueId: `video_${Date.now()}_${uploaderInfo.id}`,
                        createdAt: new Date()
                    });
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ –≤—Å–µ –≥–æ—Ç–æ–≤–æ
                    tg.sendData(JSON.stringify({ status: 'success', title: title }));
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                    tg.showAlert('–í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!', () => {
                        tg.close();
                    });

                } catch (err) {
                    console.error("Error adding document: ", err);
                    setError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                    tg.showAlert(`–û—à–∏–±–∫–∞: ${err.message}`);
                    setIsLoading(false);
                }
            };

            return (
                <div className="p-4">
                    <h1 className="text-2xl font-bold mb-4 text-[var(--tg-theme-text-color)]">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ</h1>
                    <p className="mb-4 text-[var(--tg-theme-hint-color)]">–í—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏ –≤–∏–¥–µ–æ. –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤—å—Ç–µ –¥–µ—Ç–∞–ª–∏.</p>
                    <form onSubmit={handleSubmit}>
                        <div className="mb-4">
                            <label className="block text-[var(--tg-theme-text-color)] mb-2" htmlFor="title">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input
                                id="title"
                                type="text"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                className="w-full p-2 rounded bg-[var(--tg-theme-bg-color)] border border-[var(--tg-theme-hint-color)] text-[var(--tg-theme-text-color)]"
                                placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏–∫–∞"
                            />
                        </div>
                        <div className="mb-4">
                            <label className="block text-[var(--tg-theme-text-color)] mb-2" htmlFor="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea
                                id="description"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                className="w-full p-2 rounded bg-[var(--tg-theme-bg-color)] border border-[var(--tg-theme-hint-color)] text-[var(--tg-theme-text-color)]"
                                placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"
                                rows="3"
                            ></textarea>
                        </div>
                        <div className="mb-6">
                            <label className="block text-[var(--tg-theme-text-color)] mb-2" htmlFor="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select
                                id="category"
                                value={category}
                                onChange={(e) => setCategory(e.target.value)}
                                className="w-full p-2 rounded bg-[var(--tg-theme-bg-color)] border border-[var(--tg-theme-hint-color)] text-[var(--tg-theme-text-color)]"
                            >
                                <option value="FSK">FSK</option>
                                <option value="Wizard">Wizard</option>
                                <option value="Aggressive">Aggressive</option>
                            </select>
                        </div>
                        {error && <p className="text-red-500 mb-4">{error}</p>}
                        <button
                            type="submit"
                            disabled={isLoading}
                            className="w-full p-3 rounded-lg text-[var(--tg-theme-button-text-color)]"
                            style={{ backgroundColor: `var(--tg-theme-button-color, #3498db)` }}
                        >
                            {isLoading ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å'}
                        </button>
                    </form>
                </div>
            );
        }

        // –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function App() {
            const [mode, setMode] = useState('loading'); // loading, feed, form, video_detail
            const [videos, setVideos] = useState([]);
            const [filteredVideos, setFilteredVideos] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [fileId, setFileId] = useState(null);
            const [videoDetail, setVideoDetail] = useState(null);
            const [error, setError] = useState('');

            const tg = window.Telegram.WebApp;

            useEffect(() => {
                tg.ready();
                tg.expand(); // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

                const startParam = tg.initDataUnsafe?.start_param;
                
                if (startParam) {
                    if (startParam.startsWith('file_')) {
                        setFileId(startParam.replace('file_', ''));
                        setMode('form');
                    } else if (startParam.startsWith('video_')) {
                        // TODO: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–∏–¥–µ–æ
                        setMode('video_detail');
                    }
                } else {
                    setMode('feed');
                }

                // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –≤–∏–¥–µ–æ –¥–ª—è –ª–µ–Ω—Ç—ã
                const q = window.query(videosCollection, window.orderBy("createdAt", "desc"));
                const unsubscribe = window.onSnapshot(q, (querySnapshot) => {
                    const videosData = [];
                    querySnapshot.forEach((doc) => {
                        videosData.push({ id: doc.id, ...doc.data() });
                    });
                    setVideos(videosData);
                    setFilteredVideos(videosData);
                    if(mode !== 'form') setMode('feed');
                }, (err) => {
                    console.error("Error fetching videos: ", err);
                    setError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ.');
                    setMode('error');
                });
                
                return () => unsubscribe();

            }, []);
            
            useEffect(() => {
                const results = videos.filter(video => 
                    video.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    video.description.toLowerCase().includes(searchTerm.toLowerCase())
                );
                setFilteredVideos(results);
            }, [searchTerm, videos]);

            const uploaderInfo = {
                id: tg.initDataUnsafe?.user?.id,
                firstName: tg.initDataUnsafe?.user?.first_name || '–ê–Ω–æ–Ω–∏–º'
            };

            const renderContent = () => {
                switch (mode) {
                    case 'loading':
                        return <div className="flex justify-center items-center h-screen"><div className="loader"></div></div>;
                    case 'error':
                        return <div className="p-4 text-center text-red-500">{error}</div>;
                    case 'form':
                        return <AddMetadataForm fileId={fileId} uploaderInfo={uploaderInfo} />;
                    case 'feed':
                        return (
                            <div>
                                <div className="p-4 sticky top-0 bg-[var(--tg-theme-bg-color)] z-10">
                                    <input 
                                        type="text"
                                        placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full p-3 rounded-lg bg-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-text-color)] border-none"
                                    />
                                </div>
                                {filteredVideos.length > 0 ? (
                                    filteredVideos.map(video => <VideoCard key={video.id} video={video} />)
                                ) : (
                                    <p className="text-center p-4 text-[var(--tg-theme-hint-color)]">–í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
                                )}
                                <div className="p-4 text-center text-xs text-[var(--tg-theme-hint-color)]">
                                    –ß—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –±–æ—Ç—É –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
                                </div>
                            </div>
                        );
                    default:
                        return <div className="p-4 text-center">–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫.</div>;
                }
            };

            return (
                <div className="min-h-screen">
                    {renderContent()}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
