<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
    <title>VideoShare | Платформа для видео</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* CSS переменные для цветов темы Telegram */
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f3f3f3;
        }
        
        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        
        .loader {
            border: 3px solid var(--tg-theme-secondary-bg-color);
            border-top: 3px solid var(--tg-theme-button-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .video-thumbnail {
            width: 100%;
            aspect-ratio: 16/9;
            background-color: var(--tg-theme-secondary-bg-color);
            position: relative;
            overflow: hidden;
            border-radius: 12px;
        }
        
        .play-icon {
            position: absolute;
            width: 48px;
            height: 48px;
            background-color: rgba(0,0,0,0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.2s ease;
        }

        .video-thumbnail:hover .play-icon {
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        .play-icon i {
            color: white;
            font-size: 20px;
            margin-left: 3px;
        }
        
        .progress-bar {
            height: 4px;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--tg-theme-button-color);
            transition: width 0.3s ease;
        }
        
        .backdrop-blur {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        /* Кастомный скроллбар */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--tg-theme-hint-color);
            border-radius: 3px;
        }
        .filters-container {
            overflow-x: auto;
            white-space: nowrap;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .filters-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef, createContext, useContext } = React;
        
        // --- КОНТЕКСТЫ ---
        const AuthContext = createContext(null);
        const TelegramContext = createContext(null);

        // --- ИНИЦИАЛИЗАЦИЯ SUPABASE ---
        const supabaseUrl = 'https://jmiaxlfglnyqythmjaqn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptaWF4bGZnbG55cXl0aG1qYXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjU2ODgsImV4cCI6MjA3MDc0MTY4OH0.IMRtToyrifCHxtvmSTwyB-mozqWEuDAN0u-iij2XxbE';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // --- КОНСТАНТЫ ПРИЛОЖЕНИЯ ---
        const BOT_USERNAME = 'nodaddyroll_bot';
        const MINI_APP_NAME = 'tutorials';
        const MAX_FILE_SIZE_MB = 500;
        const SUPPORTED_FORMATS = ['.mp4','.mov','.avi','.mkv','.webm','.mpg','.mpeg','.wmv','.flv'];
        const CATEGORIES = ['All', 'FSK', 'Wizard', 'Aggressive', 'Street', 'Park'];
        
        // --- ХУКИ ---
        function useTelegram() {
            return useContext(TelegramContext);
        }

        function useAuth() {
            return useContext(AuthContext);
        }

        // --- ПРОВАЙДЕР TELEGRAM ---
        function TelegramProvider({ children }) {
            const [themeParams, setThemeParams] = useState(window.Telegram.WebApp.themeParams);
            const tg = useMemo(() => window.Telegram.WebApp, []);

            useEffect(() => {
                const updateTheme = () => {
                    setThemeParams(tg.themeParams);
                    Object.entries(tg.themeParams).forEach(([key, value]) => {
                        const cssVarName = `--tg-theme-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                        document.documentElement.style.setProperty(cssVarName, value);
                    });
                };

                tg.onEvent('themeChanged', updateTheme);
                tg.ready();
                tg.expand();
                updateTheme();

                return () => {
                    tg.offEvent('themeChanged', updateTheme);
                };
            }, [tg]);

            return (
                <TelegramContext.Provider value={{ tg, themeParams }}>
                    {children}
                </TelegramContext.Provider>
            );
        }

        // --- КОМПОНЕНТЫ UI ---
        function Avatar({ user, size = 'md' }) {
            const photoUrl = user?.photo_url;

            const sizes = {
                sm: 'w-8 h-8',
                md: 'w-10 h-10',
                lg: 'w-20 h-20'
            };
            const initials = user?.first_name ? user.first_name.charAt(0).toUpperCase() : '?';

            if (photoUrl) {
                return (
                    <img src={photoUrl} alt={user.first_name} className={`${sizes[size]} rounded-full object-cover shrink-0`} />
                );
            }

            return (
                <div className={`${sizes[size]} rounded-full flex items-center justify-center text-[var(--tg-theme-button-text-color)] font-bold shrink-0`} style={{ backgroundColor: 'var(--tg-theme-button-color)' }}>
                    {initials}
                </div>
            );
        }

        // --- КОМПОНЕНТЫ ПРИЛОЖЕНИЯ ---

        function VideoCard({ video, onPlay, onShare }) {
            const [isHovered, setIsHovered] = useState(false);
            const { tg } = useTelegram();
            
            const handlePlay = () => {
                tg.HapticFeedback.impactOccurred('light');
                onPlay(video);
            };

            const handleShareClick = (e) => {
                e.stopPropagation();
                tg.HapticFeedback.notificationOccurred('success');
                onShare(video);
            };
            
            return (
                <div 
                    className="bg-[var(--tg-theme-secondary-bg-color)] rounded-xl overflow-hidden mb-4 animate-fadeIn shadow-md transition-shadow hover:shadow-lg"
                    onMouseEnter={() => setIsHovered(true)}
                    onMouseLeave={() => setIsHovered(false)}
                >
                    <div 
                        className="video-thumbnail cursor-pointer" 
                        onClick={handlePlay}
                    >
                        {video.thumbnail_url ? (
                            <img 
                                src={video.thumbnail_url} 
                                alt="Превью видео" 
                                className="w-full h-full object-cover transition-transform duration-300"
                                style={{ transform: isHovered ? 'scale(1.05)' : 'scale(1)' }}
                            />
                        ) : (
                             <div className="w-full h-full flex items-center justify-center bg-gray-700 text-gray-400">
                                <i className="fas fa-video text-4xl"></i>
                             </div>
                        )}
                        <div className="play-icon">
                            <i className="fas fa-play"></i>
                        </div>
                    </div>
                    <div className="p-4">
                        <div className="flex items-start">
                            <Avatar user={{ id: video.user_id, first_name: video.user_name }} size="md" />
                            <div className="ml-3 flex-1 min-w-0">
                                <h2 className="font-bold text-[var(--tg-theme-text-color)] line-clamp-2 leading-tight">{video.title}</h2>
                                <p className="text-sm text-[var(--tg-theme-hint-color)] truncate">{video.user_name || 'Anonymous'}</p>
                                {video.description && (
                                    <p className="text-sm text-[var(--tg-theme-text-color)] mt-1 line-clamp-2">{video.description}</p>
                                )}
                            </div>
                             <button 
                                onClick={handleShareClick}
                                className="text-[var(--tg-theme-button-color)] ml-2 text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 shrink-0"
                            >
                                <i className="fas fa-share-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        
        function UploadForm({ onClose, onUploadComplete }) {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [category, setCategory] = useState('FSK');
            const [file, setFile] = useState(null);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const { tg } = useTelegram();
            const { user } = useAuth();
            
            const isFormValid = useMemo(() => title && description && file, [title, description, file]);

            useEffect(() => {
                tg.CloudStorage.getItem('last_category', (err, value) => {
                    if (!err && value) {
                        setCategory(value);
                    }
                });
            }, [tg]);

            useEffect(() => {
                const mainButtonClickHandler = () => {
                    if (isFormValid) {
                        tg.showConfirm('Вы уверены, что хотите опубликовать это видео?', (confirmed) => {
                            if (confirmed) {
                                handleSubmit();
                            }
                        });
                    }
                };

                tg.MainButton.setParams({
                    text: 'ОПУБЛИКОВАТЬ',
                    is_active: isFormValid,
                    is_visible: true
                });

                tg.onEvent('mainButtonClicked', mainButtonClickHandler);
                
                return () => {
                    tg.offEvent('mainButtonClicked', mainButtonClickHandler);
                    tg.MainButton.hide();
                };
            }, [isFormValid, title, description, file, category]);

            useEffect(() => {
                const backButtonClickHandler = () => {
                    tg.HapticFeedback.impactOccurred('light');
                    onClose();
                };
                tg.BackButton.show();
                tg.onEvent('backButtonClicked', backButtonClickHandler);

                return () => {
                    tg.offEvent('backButtonClicked', backButtonClickHandler);
                    tg.BackButton.hide();
                };
            }, [tg, onClose]);
            
            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (!selectedFile) return;

                tg.HapticFeedback.impactOccurred('medium');
                
                if (selectedFile.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                    setError(`Файл слишком большой. Максимум: ${MAX_FILE_SIZE_MB}MB`);
                    tg.showAlert(`Файл слишком большой. Максимум: ${MAX_FILE_SIZE_MB}MB`);
                    return;
                }
                
                const fileExtension = `.${selectedFile.name.split('.').pop()}`.toLowerCase();
                if (!SUPPORTED_FORMATS.includes(fileExtension)) {
                    setError(`Неподдерживаемый формат. Разрешены: ${SUPPORTED_FORMATS.join(', ')}`);
                    tg.showAlert(`Неподдерживаемый формат. Разрешены: ${SUPPORTED_FORMATS.join(', ')}`);
                    return;
                }
                
                setError(null);
                setFile(selectedFile);
                
                generateThumbnail(selectedFile);
            };

            const generateThumbnail = (videoFile) => {
                const video = document.createElement('video');
                const url = URL.createObjectURL(videoFile);
                video.src = url;
                video.muted = true;

                video.addEventListener('loadedmetadata', () => {
                    if (video.duration) {
                        video.currentTime = video.duration / 2;
                    }
                });

                video.addEventListener('seeked', () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    setPreviewUrl(canvas.toDataURL('image/jpeg', 0.8));
                    URL.revokeObjectURL(url);
                });
            };
            
            const handleSubmit = useCallback(async () => {
                if (!isFormValid || !user) return;
                
                setIsLoading(true);
                setError(null);
                tg.MainButton.showProgress();
                
                try {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${user.id}_${Date.now()}.${fileExt}`;
                    const filePath = `public/${fileName}`;
                    
                    const { error: uploadError } = await supabase.storage
                        .from('videos')
                        .upload(filePath, file);

                    if (uploadError) throw uploadError;
                    
                    const { data: { publicUrl: videoUrl } } = supabase.storage
                        .from('videos')
                        .getPublicUrl(filePath);
                        
                    let thumbnailUrl = null;
                    if (previewUrl) {
                        const thumbnailBlob = await (await fetch(previewUrl)).blob();
                        const thumbnailPath = `public/thumbnails/${fileName}.jpg`;
                        
                        const { error: thumbnailError } = await supabase.storage
                            .from('videos')
                            .upload(thumbnailPath, thumbnailBlob);
                            
                        if (!thumbnailError) {
                            const { data: { publicUrl } } = supabase.storage
                                .from('videos')
                                .getPublicUrl(thumbnailPath);
                            thumbnailUrl = publicUrl;
                        }
                    }
                    
                    const { data, error: insertError } = await supabase
                        .from('videos')
                        .insert([{
                            title,
                            description,
                            category,
                            video_url: videoUrl,
                            thumbnail_url: thumbnailUrl,
                            user_id: user.id,
                            user_name: user.first_name,
                            user_username: user.username
                        }])
                        .select()
                        .single();
                    
                    if (insertError) throw insertError;
                    
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showPopup({
                        title: 'Готово!',
                        message: 'Видео успешно загружено.',
                        buttons: [{ type: 'ok' }]
                    });

                    tg.CloudStorage.setItem('last_category', category);
                    
                    onUploadComplete(data);
                    onClose();
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    const errorMessage = 'Ошибка загрузки. Пожалуйста, попробуйте еще раз.';
                    setError(errorMessage);
                    tg.HapticFeedback.notificationOccurred('error');
                    tg.showAlert(errorMessage);
                } finally {
                    setIsLoading(false);
                    tg.MainButton.hideProgress();
                }
            }, [isFormValid, title, description, category, file, previewUrl, user]);
            
            return (
                <div className="p-4 space-y-6 animate-fadeIn">
                    <h1 className="text-2xl font-bold text-[var(--tg-theme-text-color)]">Новое видео</h1>
                    <div>
                        <label className="block border-2 border-dashed border-[var(--tg-theme-button-color)] rounded-xl p-6 text-center cursor-pointer hover:bg-[var(--tg-theme-secondary-bg-color)] transition-colors">
                            {file ? (
                                <div className="text-[var(--tg-theme-button-color)]">
                                    <i className="fas fa-check-circle text-3xl mb-2"></i>
                                    <p className="font-semibold">{file.name}</p>
                                    <p className="text-sm text-[var(--tg-theme-hint-color)] mt-1">
                                        {(file.size / 1024 / 1024).toFixed(1)} MB
                                    </p>
                                </div>
                            ) : (
                                <div>
                                    <i className="fas fa-cloud-upload-alt text-3xl mb-2 text-[var(--tg-theme-button-color)]"></i>
                                    <p className="font-semibold text-[var(--tg-theme-button-color)]">Выберите видео</p>
                                    <p className="text-xs text-[var(--tg-theme-hint-color)] mt-1">До {MAX_FILE_SIZE_MB}MB</p>
                                </div>
                            )}
                            <input 
                                type="file" 
                                accept="video/*"
                                onChange={handleFileChange}
                                className="hidden"
                                disabled={isLoading}
                            />
                        </label>
                        {error && <p className="text-red-500 text-sm mt-2 text-center">{error}</p>}
                    </div>
                    
                    {previewUrl && (
                        <div>
                            <label className="block mb-2 font-medium text-[var(--tg-theme-text-color)]">Превью</label>
                            <div className="video-thumbnail">
                                <img src={previewUrl} alt="Превью видео" className="w-full h-full object-cover" />
                            </div>
                        </div>
                    )}
                    
                    <div className="space-y-4">
                        <input
                            type="text"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            className="w-full p-3 rounded-lg bg-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-text-color)] border-none placeholder-[var(--tg-theme-hint-color)] focus:ring-2 focus:ring-[var(--tg-theme-button-color)] outline-none"
                            placeholder="Название"
                            maxLength="100"
                            disabled={isLoading}
                        />
                        <textarea
                            value={description}
                            onChange={(e) => setDescription(e.target.value)}
                            className="w-full p-3 rounded-lg bg-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-text-color)] border-none placeholder-[var(--tg-theme-hint-color)] focus:ring-2 focus:ring-[var(--tg-theme-button-color)] outline-none"
                            placeholder="Описание"
                            rows="4"
                            maxLength="500"
                            disabled={isLoading}
                        ></textarea>
                        <select
                            value={category}
                            onChange={(e) => setCategory(e.target.value)}
                            className="w-full p-3 rounded-lg bg-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-text-color)] border-none focus:ring-2 focus:ring-[var(--tg-theme-button-color)] outline-none appearance-none"
                            disabled={isLoading}
                        >
                            {CATEGORIES.slice(1).map(cat => <option key={cat} value={cat}>{cat}</option>)}
                        </select>
                    </div>
                </div>
            );
        }
        
        function VideoPlayer({ video, onClose }) {
            const videoRef = useRef(null);
            const [isPlaying, setIsPlaying] = useState(true);
            const [isMuted, setIsMuted] = useState(false);
            const [progress, setProgress] = useState(0);
            const [duration, setDuration] = useState(0);
            const [showControls, setShowControls] = useState(true);
            const controlsTimeoutRef = useRef(null);
            const { tg } = useTelegram();

            const hideControls = () => {
                if (videoRef.current && !videoRef.current.paused) {
                    setShowControls(false);
                }
            };

            const resetControlsTimeout = () => {
                clearTimeout(controlsTimeoutRef.current);
                controlsTimeoutRef.current = setTimeout(hideControls, 3000);
            };
            
            useEffect(() => {
                const videoElement = videoRef.current;
                if (!videoElement) return;

                const onPlay = () => setIsPlaying(true);
                const onPause = () => setIsPlaying(false);
                const onTimeUpdate = () => {
                    setProgress(videoElement.currentTime);
                    resetControlsTimeout();
                };
                const onLoadedMetadata = () => setDuration(videoElement.duration);
                
                videoElement.addEventListener('play', onPlay);
                videoElement.addEventListener('pause', onPause);
                videoElement.addEventListener('timeupdate', onTimeUpdate);
                videoElement.addEventListener('loadedmetadata', onLoadedMetadata);

                resetControlsTimeout();
                
                return () => {
                    videoElement.removeEventListener('play', onPlay);
                    videoElement.removeEventListener('pause', onPause);
                    videoElement.removeEventListener('timeupdate', onTimeUpdate);
                    videoElement.removeEventListener('loadedmetadata', onLoadedMetadata);
                    clearTimeout(controlsTimeoutRef.current);
                };
            }, []);

            const togglePlay = (e) => {
                e.stopPropagation();
                tg.HapticFeedback.impactOccurred('light');
                if (videoRef.current.paused) {
                    videoRef.current.play();
                } else {
                    videoRef.current.pause();
                }
            };

            const handleSeek = (e) => {
                const seekTime = (e.nativeEvent.offsetX / e.currentTarget.offsetWidth) * duration;
                videoRef.current.currentTime = seekTime;
            };

            const toggleFullscreen = (e) => {
                e.stopPropagation();
                tg.HapticFeedback.impactOccurred('light');
                if (!document.fullscreenElement) {
                    videoRef.current.parentElement.requestFullscreen().catch(err => console.error(err));
                } else {
                    document.exitFullscreen();
                }
            };
            
            const formatTime = (time) => {
                if (isNaN(time) || time === 0) return '0:00';
                const minutes = Math.floor(time / 60);
                const seconds = Math.floor(time % 60);
                return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            };

            return (
                <div className="fixed inset-0 bg-black z-50 flex items-center justify-center animate-fadeIn">
                    <div 
                        className="relative w-full h-full"
                        onClick={() => setShowControls(s => !s)}
                    >
                        <video
                            ref={videoRef}
                            src={video.video_url}
                            className="w-full h-full object-contain"
                            autoPlay
                            playsInline
                            loop
                            muted={isMuted}
                        />

                        <div className={`absolute inset-0 transition-opacity duration-300 ${showControls ? 'opacity-100' : 'opacity-0'}`}>
                            {/* Top Controls */}
                            <div className="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/60 to-transparent flex items-center">
                                <button onClick={onClose} className="text-white text-2xl p-2 rounded-full hover:bg-white/20">
                                    <i className="fas fa-arrow-left"></i>
                                </button>
                                <h2 className="text-white font-semibold text-lg ml-4 truncate">{video.title}</h2>
                            </div>

                            {/* Center Play Button */}
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <button onClick={togglePlay} className={`text-white text-5xl bg-black/40 rounded-full w-20 h-20 flex items-center justify-center transition-all duration-300 pointer-events-auto ${isPlaying ? 'opacity-0 scale-150' : 'opacity-100 scale-100'}`}>
                                    <i className="fas fa-play ml-1"></i>
                                </button>
                            </div>

                            {/* Bottom Controls */}
                            <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/60 to-transparent">
                                <div className="w-full h-1.5 bg-white/30 rounded-full cursor-pointer" onClick={handleSeek}>
                                    <div className="h-full bg-[var(--tg-theme-button-color)] rounded-full" style={{ width: `${(progress / duration) * 100}%` }}></div>
                                </div>
                                <div className="flex items-center justify-between mt-2 text-white">
                                    <div className="flex items-center space-x-4">
                                        <button onClick={togglePlay} className="text-2xl w-8 text-center">
                                            <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'}`}></i>
                                        </button>
                                        <span className="text-sm font-mono">{formatTime(progress)} / {formatTime(duration)}</span>
                                    </div>
                                    <div className="flex items-center space-x-4">
                                        <button onClick={(e) => { e.stopPropagation(); setIsMuted(!isMuted); }} className="text-2xl w-8 text-center">
                                            <i className={`fas ${isMuted ? 'fa-volume-mute' : 'fa-volume-up'}`}></i>
                                        </button>
                                        <button onClick={toggleFullscreen} className="text-xl w-8 text-center">
                                            <i className="fas fa-expand"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        function VideoFeed({ initialVideoId }) {
            const [videos, setVideos] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showUploadForm, setShowUploadForm] = useState(false);
            const [currentVideo, setCurrentVideo] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('All');
            const { tg } = useTelegram();
            
            const loadVideos = useCallback(async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    let { data, error: supabaseError } = await supabase
                        .from('videos')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (supabaseError) throw supabaseError;
                    
                    setVideos(data || []);

                    if (initialVideoId && data) {
                        const videoToOpen = data.find(v => v.id == initialVideoId);
                        if (videoToOpen) setCurrentVideo(videoToOpen);
                    }
                } catch (err) {
                    console.error('Error loading videos:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }, [initialVideoId]);
            
            useEffect(() => {
                loadVideos();
                
                const channel = supabase
                    .channel('videos_changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'videos' }, (payload) => {
                        loadVideos();
                    })
                    .subscribe();
                
                return () => {
                    supabase.removeChannel(channel);
                };
            }, []);
            
            const filteredVideos = useMemo(() => {
                return videos.filter(video => {
                    const matchesCategory = selectedCategory === 'All' || video.category === selectedCategory;
                    const matchesSearch = !searchQuery || 
                        video.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        (video.description && video.description.toLowerCase().includes(searchQuery.toLowerCase()));
                    return matchesCategory && matchesSearch;
                });
            }, [videos, searchQuery, selectedCategory]);

            const handleShare = (video) => {
                const miniAppUrl = `https://t.me/${BOT_USERNAME}/${MINI_APP_NAME}?startapp=video_${video.id}`;
                const shareText = `Смотри видео "${video.title}"!`;
                tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(miniAppUrl)}&text=${encodeURIComponent(shareText)}`);
            };

            const handleUploadComplete = (newVideo) => {
                setVideos(prev => [newVideo, ...prev]);
                setShowUploadForm(false);
            };

            const handleCategorySelect = (category) => {
                tg.HapticFeedback.impactOccurred('light');
                setSelectedCategory(category);
            };
            
            return (
                <div className="pb-24">
                    {currentVideo && <VideoPlayer video={currentVideo} onClose={() => setCurrentVideo(null)} />}
                    
                    {showUploadForm ? (
                        <UploadForm onClose={() => setShowUploadForm(false)} onUploadComplete={handleUploadComplete} />
                    ) : (
                        <>
                            <div className="p-4 pt-4 pb-2 sticky top-0 z-10 bg-[var(--tg-theme-bg-color)] backdrop-blur bg-opacity-90">
                                <div className="relative">
                                    <i className="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-[var(--tg-theme-hint-color)]"></i>
                                    <input
                                        type="text"
                                        placeholder="Поиск видео..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        className="w-full p-3 pl-12 rounded-xl bg-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-text-color)] border-none placeholder-[var(--tg-theme-hint-color)] focus:ring-2 focus:ring-[var(--tg-theme-button-color)] outline-none"
                                    />
                                </div>
                                <div className="filters-container flex space-x-2 mt-3 pb-2">
                                    {CATEGORIES.map(category => (
                                        <button
                                            key={category}
                                            onClick={() => handleCategorySelect(category)}
                                            className={`px-4 py-2 rounded-lg text-sm font-semibold transition-colors duration-200 shrink-0 ${
                                                selectedCategory === category
                                                    ? 'bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)]'
                                                    : 'bg-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-text-color)]'
                                            }`}
                                        >
                                            {category}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="px-4">
                                {loading ? (
                                    <div className="flex justify-center items-center py-10"><div className="loader"></div></div>
                                ) : error ? (
                                    <div className="text-center py-10 text-red-500">Ошибка: {error}</div>
                                ) : filteredVideos.length === 0 ? (
                                    <div className="text-center py-20 text-[var(--tg-theme-hint-color)]">
                                        <i className="fas fa-video-slash text-4xl mb-4"></i>
                                        <p className="font-semibold">Видео не найдены</p>
                                        <p>Попробуйте другой запрос или измените категорию.</p>
                                    </div>
                                ) : (
                                    <div>
                                        {filteredVideos.map(video => (
                                            <VideoCard
                                                key={video.id}
                                                video={video}
                                                onPlay={setCurrentVideo}
                                                onShare={handleShare}
                                            />
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            <button
                                onClick={() => {
                                    tg.HapticFeedback.impactOccurred('medium');
                                    setShowUploadForm(true);
                                }}
                                className="fixed bottom-6 right-6 w-16 h-16 rounded-2xl bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)] flex items-center justify-center shadow-lg hover:opacity-90 transition-all transform active:scale-90"
                            >
                                <i className="fas fa-plus text-2xl"></i>
                            </button>
                        </>
                    )}
                </div>
            );
        }
        
        function App() {
            const [user, setUser] = useState(null);
            const [initialVideoId, setInitialVideoId] = useState(null);
            const { tg } = useTelegram();
            
            useEffect(() => {
                const tgUser = tg.initDataUnsafe?.user;
                if (tgUser) {
                    setUser(tgUser);
                } else {
                    // Для отладки в браузере
                    setUser({ id: '12345', first_name: 'Test', username: 'testuser' });
                }

                if (tg.initDataUnsafe?.start_param) {
                    const startParam = tg.initDataUnsafe.start_param;
                    if (startParam.startsWith('video_')) {
                        setInitialVideoId(startParam.replace('video_', ''));
                    }
                }
            }, [tg]);
            
            return (
                <AuthContext.Provider value={{ user }}>
                    {user ? <VideoFeed initialVideoId={initialVideoId} /> : 
                        <div className="flex items-center justify-center h-screen">
                            <div className="text-center text-[var(--tg-theme-hint-color)]">
                                <div className="loader mb-4"></div>
                                <p>Загрузка данных пользователя...</p>
                            </div>
                        </div>
                    }
                </AuthContext.Provider>
            );
        }
        
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(
            <TelegramProvider>
                <App />
            </TelegramProvider>
        );
    </script>
</body>
</html>
