<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>–ú–æ–∏ –í–∏–¥–µ–æ</title>
    <!-- Tailwind CSS –¥–ª—è —Å—Ç–∏–ª–µ–π -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel –¥–ª—è JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-button: var(--tg-theme-button-color, #2481cc);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f3f3f3);
        }
        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
        }
        .loader {
            border: 4px solid var(--tg-secondary-bg);
            border-top: 4px solid var(--tg-button);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: var(--tg-button);
            color: var(--tg-button-text);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
            z-index: 999;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        const BOT_USERNAME = "nodaddyroll_bot"; // <-- –í–ê–ñ–ù–û: –£–∫–∞–∂–∏—Ç–µ –∏–º—è –≤–∞—à–µ–≥–æ –±–æ—Ç–∞

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–∏–¥–µ–æ –¥–ª—è –ª–µ–Ω—Ç—ã
        function VideoCard({ video }) {
            const tg = window.Telegram.WebApp;
            const shareVideo = () => {
                const text = `–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫—Ä—É—Ç–æ–π —Ä–æ–ª–∏–∫: "${video.title}"`;
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º switchInlineQuery –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞
                tg.switchInlineQuery(video.title, []); 
            };

            return (
                <div className="bg-[var(--tg-secondary-bg)] rounded-xl shadow-md overflow-hidden m-4">
                    <div className="p-4">
                        <div className="flex justify-between items-center">
                            <div className="uppercase tracking-wide text-sm font-bold" style={{color: 'var(--tg-button)'}}>{video.category}</div>
                            <button onClick={shareVideo} className="text-sm p-1 rounded-md" style={{color: 'var(--tg-button)'}}>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                        </div>
                        <h2 className="block mt-1 text-lg leading-tight font-medium text-[var(--tg-text)]">{video.title}</h2>
                        <p className="mt-2 text-[var(--tg-hint)]">{video.description}</p>
                    </div>
                </div>
            );
        }

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Ñ–æ—Ä–º—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function AddMetadataForm({ fileId }) {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [category, setCategory] = useState('FSK');
            const [isLoading, setIsLoading] = useState(false);
            const tg = window.Telegram.WebApp;

            useEffect(() => {
                tg.MainButton.setParams({
                    text: '–°–û–•–†–ê–ù–ò–¢–¨ –ò –ü–û–î–ï–õ–ò–¢–¨–°–Ø',
                    color: tg.themeParams.button_color || '#2481cc',
                    text_color: tg.themeParams.button_text_color || '#ffffff',
                    is_active: false,
                    is_visible: true
                });
            }, []);

            useEffect(() => {
                if (title && description) {
                    tg.MainButton.isActive = true;
                } else {
                    tg.MainButton.isActive = false;
                }
            }, [title, description]);

            const handleSubmit = () => {
                if (!tg.MainButton.isActive) return;

                setIsLoading(true);
                tg.MainButton.showProgress();

                const dataToSend = {
                    action: 'save_video',
                    payload: {
                        fileId,
                        title,
                        description,
                        category,
                    }
                };
                
                tg.sendData(JSON.stringify(dataToSend));
                // –ë–æ—Ç –ø–æ–ª—É—á–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–∫—Ä–æ–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            };

            useEffect(() => {
                tg.onEvent('mainButtonClicked', handleSubmit);
                return () => {
                    tg.offEvent('mainButtonClicked', handleSubmit);
                };
            }, [handleSubmit]);

            return (
                <div className="p-4">
                    <h1 className="text-2xl font-bold mb-2 text-[var(--tg-text)]">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–¥–µ–æ</h1>
                    <p className="mb-6 text-[var(--tg-hint)]">–î–æ–±–∞–≤—å—Ç–µ –¥–µ—Ç–∞–ª–∏, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –º–æ–≥–ª–∏ –Ω–∞–π—Ç–∏ –≤–∞—à —Ä–æ–ª–∏–∫.</p>
                    <div className="space-y-4">
                        <input id="title" type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full p-3 rounded-lg bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] border-none placeholder-[var(--tg-hint)]" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏–∫–∞" />
                        <textarea id="description" value={description} onChange={(e) => setDescription(e.target.value)} className="w-full p-3 rounded-lg bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] border-none placeholder-[var(--tg-hint)]" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ" rows="4"></textarea>
                        <select id="category" value={category} onChange={(e) => setCategory(e.target.value)} className="w-full p-3 rounded-lg bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] border-none">
                            <option value="FSK">FSK</option>
                            <option value="Wizard">Wizard</option>
                            <option value="Aggressive">Aggressive</option>
                        </select>
                    </div>
                </div>
            );
        }

        // –≠–∫—Ä–∞–Ω "–ú–æ–∏ –í–∏–¥–µ–æ" (–õ–µ–Ω—Ç–∞)
        function VideoFeed({ userVideos }) {
             const [searchTerm, setSearchTerm] = useState('');
             const tg = window.Telegram.WebApp;

            const filteredVideos = useMemo(() => {
                if (!userVideos) return [];
                return userVideos.filter(video => 
                    (video.title?.toLowerCase() || '').includes(searchTerm.toLowerCase())
                );
            }, [searchTerm, userVideos]);

            const openBotChat = () => {
                tg.openTelegramLink(`https://t.me/${BOT_USERNAME}`);
            };

            return (
                <div>
                    <div className="p-4 sticky top-0 z-10" style={{backgroundColor: 'var(--tg-bg)'}}>
                         <input 
                            type="text"
                            placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –º–æ–∏–º –≤–∏–¥–µ–æ..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full p-3 rounded-lg bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] border-none placeholder-[var(--tg-hint)]"
                        />
                    </div>
                    {filteredVideos.length > 0 ? (
                        filteredVideos.map(video => <VideoCard key={video.fileId} video={video} />)
                    ) : (
                        <div className="text-center p-8 text-[var(--tg-hint)]">
                            <h3 className="font-bold text-lg text-[var(--tg-text)] mb-2">–í—ã –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏ –≤–∏–¥–µ–æ</h3>
                            <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ "+" —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å.</p>
                        </div>
                    )}
                    <div className="fab" onClick={openBotChat}>+</div>
                </div>
            );
        }

        // –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
        function App() {
            const [view, setView] = useState('loading'); // loading, feed, form
            const [formProps, setFormProps] = useState({});
            const [userVideos, setUserVideos] = useState([]);
            const tg = window.Telegram.WebApp;

            useEffect(() => {
                tg.ready();
                tg.expand();

                const startParam = tg.initDataUnsafe?.start_param;
                
                // –î–∞–Ω–Ω—ã–µ –æ –≤–∏–¥–µ–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ URL –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                const urlParams = new URLSearchParams(window.location.search);
                const videoData = urlParams.get('videos');

                if (videoData) {
                    try {
                        setUserVideos(JSON.parse(decodeURIComponent(videoData)));
                    } catch (e) {
                        console.error("Failed to parse video data", e);
                    }
                }

                if (startParam && startParam.startsWith('file_')) {
                    setFormProps({ fileId: startParam.replace('file_', '') });
                    setView('form');
                } else {
                    setView('feed');
                }
                
                // –£–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –º—ã –Ω–µ –≤ —Ñ–æ—Ä–º–µ
                if (!startParam) {
                    tg.MainButton.hide();
                }

            }, []);

            switch (view) {
                case 'loading':
                    return <div className="flex justify-center items-center h-screen"><div className="loader"></div></div>;
                case 'form':
                    return <AddMetadataForm {...formProps} />;
                case 'feed':
                default:
                    return <VideoFeed userVideos={userVideos} />;
            }
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
