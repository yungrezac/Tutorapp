<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Мои Видео</title>
    <!-- Tailwind CSS для стилей -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel для JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-button: var(--tg-theme-button-color, #2481cc);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f3f3f3);
        }
        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
        }
        .loader {
            border: 4px solid var(--tg-secondary-bg);
            border-top: 4px solid var(--tg-button);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: var(--tg-button);
            color: var(--tg-button-text);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
            z-index: 999;
            cursor: pointer;
        }
        .video-thumbnail {
            width: 100%;
            aspect-ratio: 16/9;
            background-color: var(--tg-secondary-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .video-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .play-icon {
            position: absolute;
            width: 48px;
            height: 48px;
            background-color: rgba(0,0,0,0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .play-icon::after {
            content: "";
            display: block;
            width: 0;
            height: 0;
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
            border-left: 20px solid white;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // Инициализация Supabase
        const supabaseUrl = 'https://jmiaxlfglnyqythmjaqn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptaWF4bGZnbG55cXl0aG1qYXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjU2ODgsImV4cCI6MjA3MDc0MTY4OH0.IMRtToyrifCHxtvmSTwyB-mozqWEuDAN0u-iij2XxbE';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Компонент карточки видео для ленты
        function VideoCard({ video, onPlay }) {
            const tg = window.Telegram.WebApp;
            const shareVideo = () => {
                const text = `Посмотрите крутой ролик: "${video.title}"`;
                tg.switchInlineQuery(video.title, []); 
            };

            return (
                <div className="bg-[var(--tg-secondary-bg)] rounded-xl shadow-md overflow-hidden m-4">
                    <div className="video-thumbnail" onClick={() => onPlay(video)}>
                        {video.thumbnail_url ? (
                            <img src={video.thumbnail_url} alt="Превью видео" />
                        ) : (
                            <div className="play-icon"></div>
                        )}
                    </div>
                    <div className="p-4">
                        <div className="flex justify-between items-center">
                            <div className="uppercase tracking-wide text-sm font-bold" style={{color: 'var(--tg-button)'}}>{video.category}</div>
                            <button onClick={shareVideo} className="text-sm p-1 rounded-md" style={{color: 'var(--tg-button)'}}>Поделиться</button>
                        </div>
                        <h2 className="block mt-1 text-lg leading-tight font-medium text-[var(--tg-text)]">{video.title}</h2>
                        <p className="mt-2 text-[var(--tg-hint)]">{video.description}</p>
                    </div>
                </div>
            );
        }

        // Компонент формы для добавления видео
        function UploadForm({ onUploadComplete }) {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [category, setCategory] = useState('FSK');
            const [file, setFile] = useState(null);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState(0);
            const tg = window.Telegram.WebApp;

            useEffect(() => {
                tg.MainButton.setParams({
                    text: 'ЗАГРУЗИТЬ ВИДЕО',
                    color: tg.themeParams.button_color || '#2481cc',
                    text_color: tg.themeParams.button_text_color || '#ffffff',
                    is_active: false,
                    is_visible: true
                });
            }, []);

            useEffect(() => {
                if (title && description && file) {
                    tg.MainButton.isActive = true;
                } else {
                    tg.MainButton.isActive = false;
                }
            }, [title, description, file]);

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    setFile(selectedFile);
                    // Создаем превью для видео
                    const video = document.createElement('video');
                    const url = URL.createObjectURL(selectedFile);
                    
                    video.addEventListener('loadedmetadata', () => {
                        // Устанавливаем время для создания превью
                        video.currentTime = Math.min(1, video.duration / 2);
                    });
                    
                    video.addEventListener('seeked', () => {
                        // Создаем canvas для извлечения кадра
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        setPreviewUrl(canvas.toDataURL('image/jpeg'));
                        URL.revokeObjectURL(url);
                    });
                    
                    video.src = url;
                }
            };

            const handleSubmit = async () => {
                if (!tg.MainButton.isActive) return;

                setIsLoading(true);
                setUploadProgress(0);
                tg.MainButton.showProgress(false);

                try {
                    // 1. Загружаем видео в Supabase Storage
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}.${fileExt}`;
                    const filePath = `${fileName}`;

                    const { error: uploadError } = await supabase.storage
                        .from('videos')
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false,
                            contentType: file.type
                        });

                    if (uploadError) throw uploadError;

                    // 2. Получаем публичный URL видео
                    const { data: videoUrl } = supabase.storage
                        .from('videos')
                        .getPublicUrl(filePath);

                    // 3. Загружаем превью (если есть)
                    let thumbnailUrl = null;
                    if (previewUrl) {
                        const thumbnailBlob = await fetch(previewUrl).then(r => r.blob());
                        const thumbnailPath = `thumbnails/${fileName}.jpg`;
                        
                        const { error: thumbnailError } = await supabase.storage
                            .from('videos')
                            .upload(thumbnailPath, thumbnailBlob, {
                                cacheControl: '3600',
                                upsert: false,
                                contentType: 'image/jpeg'
                            });

                        if (!thumbnailError) {
                            const { data: thumbnailData } = supabase.storage
                                .from('videos')
                                .getPublicUrl(thumbnailPath);
                            thumbnailUrl = thumbnailData.publicUrl;
                        }
                    }

                    // 4. Сохраняем метаданные в таблицу videos
                    const { data, error } = await supabase
                        .from('videos')
                        .insert([{
                            title,
                            description,
                            category,
                            video_url: videoUrl.publicUrl,
                            thumbnail_url: thumbnailUrl,
                            user_id: tg.initDataUnsafe.user?.id || 'anonymous',
                            user_name: tg.initDataUnsafe.user?.first_name || 'Anonymous'
                        }])
                        .select();

                    if (error) throw error;

                    // 5. Возвращаем данные о новом видео
                    const newVideo = data[0];
                    onUploadComplete(newVideo);
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    tg.showAlert(`Ошибка загрузки: ${error.message}`);
                    tg.MainButton.hideProgress();
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => {
                tg.onEvent('mainButtonClicked', handleSubmit);
                return () => {
                    tg.offEvent('mainButtonClicked', handleSubmit);
                };
            }, [handleSubmit]);

            return (
                <div className="p-4">
                    <h1 className="text-2xl font-bold mb-2 text-[var(--tg-text)]">Загрузка видео</h1>
                    <p className="mb-6 text-[var(--tg-hint)]">Добавьте видео и информацию о нем.</p>
                    
                    <div className="mb-4">
                        <label className="block mb-2 text-sm font-medium text-[var(--tg-text)]">Видео файл</label>
                        <input 
                            type="file" 
                            accept="video/*" 
                            onChange={handleFileChange}
                            className="w-full p-2 rounded-lg bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] border-none"
                        />
                        {previewUrl && (
                            <div className="mt-2 video-thumbnail">
                                <img src={previewUrl} alt="Превью видео" />
                            </div>
                        )}
                    </div>
                    
                    <div className="space-y-4">
                        <input 
                            id="title" 
                            type="text" 
                            value={title} 
                            onChange={(e) => setTitle(e.target.value)} 
                            className="w-full p-3 rounded-lg bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] border-none placeholder-[var(--tg-hint)]" 
                            placeholder="Название ролика" 
                        />
                        <textarea 
                            id="description" 
                            value={description} 
                            onChange={(e) => setDescription(e.target.value)} 
                            className="w-full p-3 rounded-lg bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] border-none placeholder-[var(--tg-hint)]" 
                            placeholder="Краткое описание" 
                            rows="4"
                        ></textarea>
                        <select 
                            id="category" 
                            value={category} 
                            onChange={(e) => setCategory(e.target.value)} 
                            className="w-full p-3 rounded-lg bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] border-none"
                        >
                            <option value="FSK">FSK</option>
                            <option value="Wizard">Wizard</option>
                            <option value="Aggressive">Aggressive</option>
                        </select>
                    </div>
                    
                    {isLoading && (
                        <div className="mt-4">
                            <div className="w-full bg-[var(--tg-secondary-bg)] rounded-full h-2.5">
                                <div 
                                    className="bg-[var(--tg-button)] h-2.5 rounded-full" 
                                    style={{width: `${uploadProgress}%`}}
                                ></div>
                            </div>
                            <p className="text-center mt-2 text-[var(--tg-hint)]">{uploadProgress}%</p>
                        </div>
                    )}
                </div>
            );
        }

        // Компонент просмотра видео
        function VideoPlayer({ video, onClose }) {
            return (
                <div className="fixed inset-0 bg-black z-50 flex flex-col">
                    <div className="p-4 flex justify-between items-center bg-black bg-opacity-50">
                        <button 
                            onClick={onClose}
                            className="text-white text-lg font-bold"
                        >
                            ×
                        </button>
                        <h2 className="text-white text-lg font-medium">{video.title}</h2>
                        <div></div> {/* Пустой div для выравнивания */}
                    </div>
                    <div className="flex-1 flex items-center justify-center">
                        <video 
                            controls 
                            autoPlay 
                            className="w-full h-full object-contain"
                            src={video.video_url}
                        >
                            Ваш браузер не поддерживает видео тег.
                        </video>
                    </div>
                </div>
            );
        }

        // Экран "Мои Видео" (Лента)
        function VideoFeed({ userVideos, onUpload }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [showUploadForm, setShowUploadForm] = useState(false);
            const [currentVideo, setCurrentVideo] = useState(null);
            const tg = window.Telegram.WebApp;

            const filteredVideos = useMemo(() => {
                if (!userVideos) return [];
                return userVideos.filter(video => 
                    (video.title?.toLowerCase() || '').includes(searchTerm.toLowerCase()) ||
                    (video.description?.toLowerCase() || '').includes(searchTerm.toLowerCase()) ||
                    (video.category?.toLowerCase() || '').includes(searchTerm.toLowerCase())
                );
            }, [searchTerm, userVideos]);

            const handleUploadComplete = (newVideo) => {
                onUpload(prev => [newVideo, ...prev]);
                setShowUploadForm(false);
            };

            return (
                <div>
                    {currentVideo && (
                        <VideoPlayer 
                            video={currentVideo} 
                            onClose={() => setCurrentVideo(null)} 
                        />
                    )}
                    
                    {showUploadForm ? (
                        <UploadForm onUploadComplete={handleUploadComplete} />
                    ) : (
                        <>
                            <div className="p-4 sticky top-0 z-10" style={{backgroundColor: 'var(--tg-bg)'}}>
                                <input 
                                    type="text"
                                    placeholder="🔍 Поиск по видео..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full p-3 rounded-lg bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] border-none placeholder-[var(--tg-hint)]"
                                />
                            </div>
                            
                            {filteredVideos.length > 0 ? (
                                filteredVideos.map(video => (
                                    <VideoCard 
                                        key={video.id} 
                                        video={video} 
                                        onPlay={setCurrentVideo}
                                    />
                                ))
                            ) : (
                                <div className="text-center p-8 text-[var(--tg-hint)]">
                                    <h3 className="font-bold text-lg text-[var(--tg-text)] mb-2">Видео не найдены</h3>
                                    <p>Нажмите на "+" чтобы загрузить новое видео.</p>
                                </div>
                            )}
                            
                            <div className="fab" onClick={() => setShowUploadForm(true)}>+</div>
                        </>
                    )}
                </div>
            );
        }

        // Главный компонент
        function App() {
            const [view, setView] = useState('loading'); // loading, feed
            const [userVideos, setUserVideos] = useState([]);
            const tg = window.Telegram.WebApp;

            useEffect(() => {
                tg.ready();
                tg.expand();

                // Загрузка видео из Supabase
                const loadVideos = async () => {
                    try {
                        const { data, error } = await supabase
                            .from('videos')
                            .select('*')
                            .order('created_at', { ascending: false });

                        if (error) throw error;

                        setUserVideos(data || []);
                    } catch (error) {
                        console.error("Error loading videos:", error);
                        tg.showAlert("Ошибка при загрузке видео");
                    } finally {
                        setView('feed');
                    }
                };

                loadVideos();
                
                // Убираем основную кнопку, если мы не в форме
                tg.MainButton.hide();

                // Подписка на изменения в таблице videos
                const channel = supabase
                    .channel('videos_changes')
                    .on(
                        'postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'videos' },
                        (payload) => {
                            setUserVideos(prev => [payload.new, ...prev]);
                        }
                    )
                    .subscribe();

                return () => {
                    supabase.removeChannel(channel);
                };
            }, []);

            switch (view) {
                case 'loading':
                    return <div className="flex justify-center items-center h-screen"><div className="loader"></div></div>;
                case 'feed':
                default:
                    return <VideoFeed userVideos={userVideos} onUpload={setUserVideos} />;
            }
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
